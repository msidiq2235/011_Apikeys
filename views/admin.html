<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <style>
        body { font-family: sans-serif; max-width: 800px; margin: 20px auto; }
        .container { display: none; }
        #loginArea, #registerArea { max-width: 400px; border: 1px solid #ccc; padding: 20px; }
        div { margin-bottom: 15px; }
        input, button { width: 100%; padding: 10px; box-sizing: border-box; }
        table { width: 100%; border-collapse: collapse; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background: #f4f4f4; }
        pre { background: #f4f4f4; padding: 10px; border-radius: 5px; word-wrap: break-word; }
    </style>
</head>
<body>
    <h2>Admin Dashboard</h2>

    <div id="loginArea">
        <h3>Admin Login</h3>
        <input type="email" id="loginEmail" placeholder="admin@mail.com">
        <input type="password" id="loginPass" placeholder="password">
        <button id="btnLogin">Login</button>
        <pre id="loginResult"></pre>
    </div>
    
    <div id="registerArea" style="margin-top: 20px;">
        <h3>Admin Register (Optional)</h3>
        <input type="email" id="regEmail" placeholder="new-admin@mail.com">
        <input type="password" id="regPass" placeholder="password">
        <button id="btnRegister">Register</button>
        <pre id="registerResult"></pre>
    </div>
    
    <hr>

    <div id="adminContent" class="container">
        <h3>Welcome, Admin!</h3>
        <button id="btnLogout" style="background: #f44;">Logout</button>
        <br><br>
        
        <button id="btnGetUsers">Get List Users</button>
        <div id="usersList"></div>

        <button id="btnGetApiKeys" style="margin-top: 20px;">Get List API Keys</button>
        <div id="apiKeysList"></div>
    </div>

    <script>
        const loginArea = document.getElementById('loginArea');
        const registerArea = document.getElementById('registerArea');
        const adminContent = document.getElementById('adminContent');
        
        let authToken = localStorage.getItem('adminToken');

        // Cek jika sudah login
        if (authToken) {
            loginArea.style.display = 'none';
            registerArea.style.display = 'none';
            adminContent.style.display = 'block';
        }

        // --- Register ---
        document.getElementById('btnRegister').addEventListener('click', async () => {
            const email = document.getElementById('regEmail').value;
            const password = document.getElementById('regPass').value;
            const resEl = document.getElementById('registerResult');
            
            try {
                const res = await fetch('/api/admin/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                const data = await res.json();
                resEl.textContent = JSON.stringify(data, null, 2);
            } catch (err) {
                resEl.textContent = err.message;
            }
        });

        // --- Login ---
        document.getElementById('btnLogin').addEventListener('click', async () => {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPass').value;
            const resEl = document.getElementById('loginResult');
            
            try {
                const res = await fetch('/api/admin/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                const data = await res.json();

                if (data.accessToken) {
                    localStorage.setItem('adminToken', data.accessToken);
                    authToken = data.accessToken;
                    loginArea.style.display = 'none';
                    registerArea.style.display = 'none';
                    adminContent.style.display = 'block';
                    resEl.textContent = 'Login berhasil!';
                } else {
                    resEl.textContent = JSON.stringify(data, null, 2);
                }
            } catch (err) {
                resEl.textContent = err.message;
            }
        });

        // --- Logout ---
        document.getElementById('btnLogout').addEventListener('click', () => {
            localStorage.removeItem('adminToken');
            authToken = null;
            adminContent.style.display = 'none';
            loginArea.style.display = 'block';
            registerArea.style.display = 'block';
            document.getElementById('usersList').innerHTML = '';
            document.getElementById('apiKeysList').innerHTML = '';
        });

        // --- Function untuk fetch data terproteksi ---
        async function fetchProtectedData(url) {
            if (!authToken) return { error: "No token" };
            
            const res = await fetch(url, {
                headers: { 'Authorization': `Bearer ${authToken}` }
            });
            return res.json();
        }

        // --- Get Users ---
        document.getElementById('btnGetUsers').addEventListener('click', async () => {
            const data = await fetchProtectedData('/api/admin/users');
            const listEl = document.getElementById('usersList');
            
            if (data.message) {
                listEl.innerHTML = `<pre>${data.message}</pre>`;
                return;
            }
            
            let table = '<h4>List Users</h4><table><tr><th>ID</th><th>Email</th><th>First</th><th>Last</th></tr>';
            data.forEach(user => {
                table += `<tr><td>${user.id}</td><td>${user.email}</td><td>${user.firstname}</td><td>${user.lastname}</td></tr>`;
            });
            table += '</table>';
            listEl.innerHTML = table;
        });

        // --- Get API Keys ---
        document.getElementById('btnGetApiKeys').addEventListener('click', async () => {
            const data = await fetchProtectedData('/api/admin/apikeys');
            const listEl = document.getElementById('apiKeysList');

            if (data.message) {
                listEl.innerHTML = `<pre>${data.message}</pre>`;
                return;
            }

            // Sesuai permintaan: key, out of date, status inactive, user
            let table = '<h4>List API Keys</h4><table><tr><th>Key</th><th>Out of Date</th><th>Status</th><th>User Email</th><th>User Name</th></tr>';
            data.forEach(k => {
                table += `<tr>
                            <td>${k.key}</td>
                            <td>${k.out_of_date}</td>
                            <td>${k.status_inactive}</td>
                            <td>${k.user_email}</td>
                            <td>${k.user_name}</td>
                        </tr>`;
            });
            table += '</table>';
            listEl.innerHTML = table;
        });
    </script>
</body>
</html>